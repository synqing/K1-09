{
  "audio_pipeline": [
    {
      "consumers": [
        "Scaling stage"
      ],
      "notes": {
        "bytes_expected": "CONFIG.SAMPLES_PER_CHUNK * 4",
        "timeout": "portMAX_DELAY to forbid partial reads"
      },
      "output": "audio_raw_state.getRawSamples()",
      "producer": "i2s_audio::acquire_sample_chunk",
      "range": "Left-justified 32-bit PCM (\u00b18M)",
      "stage": "I2S DMA read",
      "type": "int32_t[SAMPLES_PER_CHUNK]"
    },
    {
      "consumers": [
        "audio_processed_state",
        "sample_window"
      ],
      "notes": {
        "dc_offset": "CONFIG.DC_OFFSET (-14800)",
        "min_state_duration_ms": 1500,
        "sensitivity": "CONFIG.SENSITIVITY (default 1.0)"
      },
      "output": "waveform / audio_processed_state",
      "producer": "i2s_audio::acquire_sample_chunk",
      "range": "\u00b132767 (clamped)",
      "stage": "Linear scaling & DC removal",
      "type": "int16_t[256]"
    },
    {
      "consumers": [
        "AGC",
        "sweet spot",
        "LED gating"
      ],
      "notes": {
        "attack": 0.5,
        "decay": 0.02,
        "floor": "CONFIG.SWEET_SPOT_MIN_LEVEL (>=750)"
      },
      "output": "max_waveform_val_*",
      "producer": "i2s_audio::acquire_sample_chunk",
      "range": "0-32767",
      "stage": "Peak tracking & AGC",
      "type": "float"
    },
    {
      "consumers": [
        "process_GDFT"
      ],
      "notes": {
        "guard": "0xABCD1234"
      },
      "output": "audio_raw_state.waveform_history_",
      "producer": "i2s_audio::acquire_sample_chunk",
      "range": "Clamped waveform",
      "stage": "Sample history",
      "type": "int16_t[4][1024]"
    },
    {
      "consumers": [
        "process_GDFT"
      ],
      "notes": {
        "history_length": 4096
      },
      "output": "sample_window",
      "producer": "i2s_audio::acquire_sample_chunk",
      "range": "\u00b132767",
      "stage": "Sliding window",
      "type": "int16_t[4096]"
    },
    {
      "consumers": [
        "spectrogram",
        "noise_calibration",
        "lightshow_modes"
      ],
      "notes": {
        "fast_sqrt_constant": "0x5f375a86",
        "num_freqs": 64
      },
      "output": "magnitudes_normalized",
      "producer": "process_GDFT",
      "range": ">=0",
      "stage": "Goertzel transform",
      "type": "float[NUM_FREQS]"
    },
    {
      "consumers": [
        "process_GDFT"
      ],
      "notes": {
        "iterations": 256
      },
      "output": "noise_samples",
      "producer": "process_GDFT",
      "range": "0-1",
      "stage": "Noise calibration",
      "type": "SQ15x16[NUM_FREQS]"
    },
    {
      "consumers": [
        "lightshow_modes",
        "serial_menu"
      ],
      "notes": {
        "ema_factor": 0.3
      },
      "output": "spectrogram / chromagram",
      "producer": "process_GDFT",
      "range": "0-1",
      "stage": "Spectrogram smoothing",
      "type": "SQ15x16[]"
    }
  ],
  "magic_numbers": {
    "BLOOM_DECAY": {
      "location": "src/lightshow_modes.h:603",
      "rationale": "Trail persistence for bloom mode",
      "value": 0.78
    },
    "CONFIG.MAX_CURRENT_MA": {
      "location": "src/core/globals.cpp:31",
      "rationale": "LED power budget for 160 WS2812 pixels",
      "value": 1500
    },
    "CONFIG.SAMPLES_PER_CHUNK": {
      "location": "src/core/globals.cpp:24",
      "rationale": "Latency vs resolution trade-off; 16 ms window at 16 kHz",
      "value": 256
    },
    "MIN_STATE_DURATION_MS": {
      "location": "src/i2s_audio.h:51",
      "rationale": "Prevents AGC thrash between loud/silent states",
      "value": 1500
    },
    "fast_sqrt_constant": {
      "location": "src/GDFT.h:120",
      "rationale": "Fast inverse sqrt approximation for magnitude normalization",
      "value": "0x5f375a86"
    }
  },
  "visual_pipeline": [
    {
      "consumers": [
        "lightshow_modes",
        "led_utilities"
      ],
      "notes": {
        "frame_seq": [
          "g_frame_seq_write",
          "g_frame_seq_ready",
          "g_frame_seq_shown"
        ]
      },
      "output": "leds_16 / leds_16_fx / leds_16_ui",
      "producer": "led_thread",
      "range": "0-1 (Q8.8)",
      "stage": "Frame initialization",
      "type": "CRGB16[LED_COUNT]"
    },
    {
      "consumers": [
        "lightshow_modes"
      ],
      "notes": {
        "dither": "dither_table[8]"
      },
      "output": "palette LUTs",
      "producer": "led_utilities::update_palette_buffers",
      "range": "0-1",
      "stage": "Palette prep",
      "type": "CRGB16[]"
    },
    {
      "consumers": [
        "led_utilities"
      ],
      "notes": {
        "selector": "CONFIG.LIGHTSHOW_MODE"
      },
      "output": "mode buffers",
      "producer": "lightshow_modes::render_active_mode",
      "range": "0-1",
      "stage": "Mode dispatch",
      "type": "CRGB16[]"
    },
    {
      "consumers": [
        "compose_frame"
      ],
      "notes": {
        "inputs": [
          "spectrogram_smooth",
          "hue_lookup"
        ]
      },
      "output": "leds_16_fx",
      "producer": "light_mode_gdft",
      "range": "0-1",
      "stage": "GDFT mode",
      "type": "CRGB16[160]"
    },
    {
      "consumers": [
        "compose_frame"
      ],
      "notes": {
        "decay": 0.78,
        "sparkle_threshold": 0.45
      },
      "output": "leds_16_fx / leds_16_prev_secondary",
      "producer": "light_mode_bloom",
      "range": "0-1",
      "stage": "Bloom mode",
      "type": "CRGB16[160]"
    },
    {
      "consumers": [
        "compose_frame"
      ],
      "notes": {
        "fluid_diffusion": 0.035,
        "particle_drag": 0.98
      },
      "output": "particle buffers / leds_16_fx",
      "producer": "light_mode_quantum_collapse",
      "range": "mode-specific",
      "stage": "Quantum collapse",
      "type": "float[] / CRGB16[]"
    },
    {
      "consumers": [
        "compose_frame"
      ],
      "notes": {
        "inputs": [
          "audio_processed_state.waveform"
        ]
      },
      "output": "leds_16_fx",
      "producer": "light_mode_waveform",
      "range": "0-1",
      "stage": "Waveform mode",
      "type": "CRGB16[160]"
    },
    {
      "consumers": [
        "FastLED.show"
      ],
      "notes": {
        "current_limit_ma": 1500,
        "mirror": "CONFIG.MIRROR_ENABLED"
      },
      "output": "leds_out",
      "producer": "led_utilities::compose_frame",
      "range": "0-255",
      "stage": "Frame compositing",
      "type": "CRGB[LED_COUNT]"
    }
  ]
}